# Karaoke Video Generator

è¿™æ˜¯ä¸€ä¸ªåŸºäº Python çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œç”¨äºå°†éŸ³é¢‘æ–‡ä»¶å’ŒèƒŒæ™¯å›¾ç‰‡åˆå¹¶ç”Ÿæˆå¸¦æœ‰å¡æ‹‰ OK å­—å¹•æ•ˆæœçš„è§†é¢‘ (MP4)ã€‚

å®ƒä½¿ç”¨ **Faster-Whisper** è¿›è¡Œè¯­éŸ³è¯†åˆ«å’Œæ—¶é—´æˆ³æå–ï¼Œç”Ÿæˆ **ASS å­—å¹•**ï¼ˆåŒ…å«é€å­—å¡æ‹‰ OK æ•ˆæœï¼‰ï¼Œå¹¶ä½¿ç”¨ **FFmpeg** æ¸²æŸ“æœ€ç»ˆè§†é¢‘ã€‚åŒæ—¶ä¹Ÿå†…ç½®äº†ä¸€ä¸ªç®€å•çš„ SQLite ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿã€‚

## åŠŸèƒ½

- ğŸ™ï¸ **è‡ªåŠ¨è½¬å½•**ï¼šä½¿ç”¨ `faster-whisper` é«˜æ•ˆæå–éŸ³é¢‘æ–‡æœ¬å’Œå•è¯çº§æ—¶é—´æˆ³ã€‚
- ğŸµ **å¡æ‹‰ OK å­—å¹•**ï¼šç”Ÿæˆ `.ass` å­—å¹•æ–‡ä»¶ï¼Œæ”¯æŒå¹³æ»‘çš„é€å­—é«˜äº®æ•ˆæœã€‚
- ğŸ¬ **è§†é¢‘åˆæˆ**ï¼šå°†éŸ³é¢‘ã€é™æ€èƒŒæ™¯å›¾å’ŒåŠ¨æ€å­—å¹•åˆæˆä¸º 1080p MP4 è§†é¢‘ã€‚
- ğŸ†™ **è‡ªåŠ¨ä¸Šä¼ **ï¼šæ”¯æŒ Bilibili è§†é¢‘ä¸Šä¼ ï¼ˆå•è§†é¢‘æˆ–æ‰¹é‡ä»»åŠ¡ï¼‰ï¼ŒåŒ…å«æ‰«ç ç™»å½•åŠŸèƒ½ã€‚
- ğŸ“ **ä»»åŠ¡ç®¡ç†**ï¼šä½¿ç”¨ SQLite æ•°æ®åº“è¿½è¸ªä»»åŠ¡çŠ¶æ€ï¼ˆç­‰å¾…ä¸­ã€å¤„ç†ä¸­ã€å®Œæˆã€å¤±è´¥ï¼‰ã€‚
- ğŸ–¥ï¸ **Mac ä¼˜åŒ–**ï¼šåŒ…å«é’ˆå¯¹ macOS çš„ OpenMP ç¯å¢ƒå˜é‡ä¿®å¤ã€‚

## ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿä¾èµ–
å¿…é¡»å®‰è£… **FFmpeg** å¹¶ç¡®ä¿å…¶åœ¨ç³»ç»Ÿ `PATH` ä¸­ã€‚
- **macOS (Homebrew)**: `brew install ffmpeg`
- **Linux**: `sudo apt install ffmpeg`
- **Windows**: ä¸‹è½½å¹¶é…ç½®ç¯å¢ƒå˜é‡ã€‚

### Python ä¾èµ–
è¯·ç¡®ä¿ä½¿ç”¨ Python 3.8+ã€‚
```bash
pip install -r requirements.txt
```
pip install -r requirements.txt
```
*ä¸»è¦ä¾èµ–åº“ï¼š`faster-whisper`, `SQLAlchemy`, `torch`, `tqdm`, `bilibili-api-python`, `Pillow`*

## å¿«é€Ÿå¼€å§‹

### å‘½ä»¤è¡Œä½¿ç”¨

ç›´æ¥è¿è¡Œè„šæœ¬ï¼Œä¼ å…¥éŸ³é¢‘æ–‡ä»¶è·¯å¾„å’ŒèƒŒæ™¯å›¾ç‰‡è·¯å¾„ï¼š

```bash
python karaoke_gen.py <audio_path> <image_path>
```

**ç¤ºä¾‹ï¼š**
```bash
python karaoke_gen.py song.mp3 background.jpg
```

è„šæœ¬å°†è‡ªåŠ¨ï¼š
1. åˆ›å»ºæ•°æ®åº“ä»»åŠ¡ã€‚
2. å¼€å§‹è½¬å½•ã€‚
3. ç”Ÿæˆå­—å¹•å’Œè§†é¢‘ã€‚
4. è¾“å‡ºæ–‡ä»¶ä¿å­˜åœ¨ `output/` ç›®å½•ä¸‹ã€‚

### Bilibili ä¸Šä¼ 

1. **ç™»å½•**ï¼ˆæ‰«ç ï¼‰ï¼š
   ```bash
   python bili_upload.py --login
   ```
   *å‡­è¯å°†ä¿å­˜åœ¨æœ¬åœ° `bili_sess.json`ï¼ˆè¯·å‹¿æ³„éœ²ï¼‰ã€‚*

2. **å•è§†é¢‘ä¸Šä¼ **ï¼š
   ```bash
   python bili_upload.py --upload output/video.mp4 --title "æˆ‘çš„è§†é¢‘" --cover cover.jpg
   ```

3. **æ‰¹é‡ä¸Šä¼ **ï¼ˆç»“åˆä»»åŠ¡ç³»ç»Ÿï¼‰ï¼š
   ç¡®ä¿ `tasks.json` å­˜åœ¨å¹¶é…ç½®æ­£ç¡®ï¼Œç„¶åè¿è¡Œï¼š
   ```bash
   python bili_upload.py --batch tasks.json
   ```

### ä»£ç è°ƒç”¨

ä½ ä¹Ÿå¯ä»¥åœ¨å…¶ä»– Python è„šæœ¬ä¸­å¯¼å…¥ä½¿ç”¨ï¼š

```python
from karaoke_gen import KaraokeGenerator

gen = KaraokeGenerator()
task_id = gen.add_task("test_audio.mp3", "bg.jpg")
gen.process_pending_tasks()
```

## è¾“å‡ºæ–‡ä»¶

æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶éƒ½ä½äº `output/` æ–‡ä»¶å¤¹ä¸­ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º `{filename}_{timestamp}`ï¼š
- `*.txt`: çº¯æ–‡æœ¬æ­Œè¯
- `*.ass`: å¡æ‹‰ OK å­—å¹•æ–‡ä»¶
- `*.mp4`: æœ€ç»ˆåˆæˆçš„è§†é¢‘

## é…ç½®ä¸è‡ªå®šä¹‰

- **å­—å¹•æ ·å¼**ï¼šåœ¨ `KaraokeGenerator` ç±»çš„ `SubtitleGenerator.generate_ass` æ–¹æ³•ä¸­ä¿®æ”¹ `[V4+ Styles]`ã€‚
- **å­—å¹•ä½ç½®**ï¼šç›®å‰é»˜è®¤åœ¨å±å¹•ä¸­å¿ƒåä¸‹ä½ç½®ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè¯·è°ƒæ•´ä»£ç ä¸­çš„ `\pos(x,y)` å‚æ•°ã€‚
- **æ¨¡å‹å¤§å°**ï¼šé»˜è®¤ä½¿ç”¨ `base` æ¨¡å‹ã€‚åœ¨ `KaraokeGenerator.__init__` ä¸­å¯ä¿®æ”¹ `Transcriber(model_size="medium")` ä»¥è·å¾—æ›´é«˜ç²¾åº¦ã€‚

## å¸¸è§é—®é¢˜

**Q: æŠ¥é”™ `OMP: Error #15: Initializing libomp.dylib...`**
A: è„šæœ¬å·²å†…ç½® `os.environ["KMP_DUPLICATE_LIB_OK"] = "TRUE"` ä¿®å¤æ­¤é—®é¢˜ï¼Œé€šå¸¸æ— éœ€é¢å¤–æ“ä½œã€‚

**Q: ç”Ÿæˆé€Ÿåº¦æ…¢ï¼Ÿ**
A: `faster-whisper` é»˜è®¤åœ¨ CPU ä¸Šè¿è¡Œï¼ˆä¸ºäº†å…¼å®¹æ€§ï¼‰ã€‚å¦‚æœæœ‰ NVIDIA æ˜¾å¡ï¼Œå¯ä»¥ä¿®æ”¹ `Transcriber` ç±»ä¸­çš„ `device="cuda"` ä»¥åŠ é€Ÿã€‚
